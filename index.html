<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="AR-—Å—Ü–µ–Ω–∞ –∑ –ø–ª–∞–Ω–µ—Ç–æ—é –¥–ª—è –¥—ñ—Ç–µ–π">
    <title>üåç –ú–∏—Ä –Ω–∞ –¥–æ–ª–æ–Ω—ñ üéà</title>

    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <!-- –í–∏–¥–∞–ª—è—î–º–æ MindAR, –±–æ –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –º–∞—Ä–∫–µ—Ä -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script> -->

    <!-- TensorFlow.js —ñ Handpose -->
    <script src="https://unpkg.com/@tensorflow/tfjs-core@4.17.0/dist/tf-core.js"></script>
    <script src="https://unpkg.com/@tensorflow/tfjs-converter@4.17.0/dist/tf-converter.js"></script>
    <script src="https://unpkg.com/@tensorflow/tfjs-backend-webgl@4.17.0/dist/tf-backend-webgl.js"></script>
    <script src="https://unpkg.com/@tensorflow-models/hand-pose-detection@2.0.1"></script>

    <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: transparent; }
        a-scene { width: 100% !important; height: 100% !important; position: fixed; top: 0; left: 0; }
        .arjs-loader { height: 100%; width: 100%; position: absolute; top: 0; left: 0; background: rgba(135, 206, 235, 0.2); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #FF4500; font-size: 1.8em; text-align: center; padding: 20px; box-sizing: border-box; font-family: 'Comic Neue', 'Comic Sans MS', cursive, sans-serif; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .pulse { animation: pulse 1.5s infinite; }
        .controls { position: absolute; bottom: 20px; left: 20px; z-index: 10000; }
        .sound-btn, .youtube-btn { padding: 10px 20px; margin-right: 10px; border: none; border-radius: 15px; cursor: pointer; font-family: 'Comic Neue', 'Comic Sans MS', cursive, sans-serif; font-size: 1em; }
        .sound-btn { background-color: #4CAF50; color: white; }
        .sound-btn.off { background-color: #f44336; }
        .youtube-btn { background-color: #FF9800; color: white; text-decoration: none; display: inline-block; }
        .youtube-btn:hover { background-color: #FFB300; }
        #hand-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 9998; display: block; }
    </style>
</head>
<body>
    <div class="arjs-loader" id="loader">
        <div class="pulse">üåç –ú–∏—Ä –Ω–∞ –¥–æ–ª–æ–Ω—ñ üéà</div>
        <div style="margin-top: 20px; font-size: 1.2em;">–ü—ñ–¥–Ω—ñ–º–∏ —Ä—É–∫—É –ø–µ—Ä–µ–¥ –∫–∞–º–µ—Ä–æ—é! üòäüé®</div>
    </div>

    <canvas id="hand-canvas" width="640" height="480"></canvas>

    <a-scene
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        loading-screen="enabled: false"
        embedded
        renderer="colorManagement: true; physicallyCorrectLights: true;"
    >
        <a-assets>
            <audio id="bg-music" src="./bg-music.mp3" preload="auto" loop></audio>
        </a-assets>

        <a-camera
            id="camera"
            look-controls="enabled: false"
            position="0 0 0"
        ></a-camera>

        <a-sphere
            id="hand-planet"
            position="0 0 -0.5"
            radius="0.2"
            src="./earth.jpg"
            visible="false"
            gesture-handler
        >
            <a-animation
                attribute="rotation"
                to="0 360 0"
                dur="5000"
                repeat="indefinite"
                begin="fly"
            ></a-animation>
        </a-sphere>
    </a-scene>

    <div class="controls">
        <button id="sound-btn" class="sound-btn">–£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫</button>
        <a href="https://www.youtube.com/playlist?list=PL6UDFwT9TzFw5K8Tzu_OgsDz7vV3N9eY-" target="_blank" class="youtube-btn">YouTube SmartLessa</a>
    </div>

    <script>
        function fixHeight() { document.body.style.height = window.innerHeight + 'px'; }
        fixHeight();
        window.addEventListener('resize', fixHeight);

        const loader = document.querySelector('#loader');
        const handPlanet = document.querySelector('#hand-planet');
        const bgMusic = document.querySelector('#bg-music');
        const soundBtn = document.querySelector('#sound-btn');
        const canvas = document.querySelector('#hand-canvas');
        const ctx = canvas.getContext('2d');
        let handDetector = null;
        let handDetected = false;
        let handPosition = { x: 0, y: 0, z: 0 };
        let lastHandPosition = { x: 0, y: 0 };
        let lastMoveTime = 0;
        const MOVE_THRESHOLD = 0.05;
        const STILL_TIME = 1000;

        document.addEventListener('DOMContentLoaded', () => {
            console.log("‚úÖ DOM –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ");
            initHandDetection();
        });

        soundBtn.addEventListener('click', () => {
            if (bgMusic.paused) {
                bgMusic.play().catch(e => console.log("üîá –ü–æ–º–∏–ª–∫–∞ –º—É–∑–∏–∫–∏:", e));
                soundBtn.classList.remove('off');
                soundBtn.textContent = '–í–∏–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫';
            } else {
                bgMusic.pause();
                soundBtn.classList.add('off');
                soundBtn.textContent = '–£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫';
            }
        });

        async function initHandDetection() {
            try {
                const model = handPoseDetection.SupportedModels.MediaPipeHands;
                const detectorConfig = {
                    runtime: 'mediapipe',
                    solutionPath: 'https://cdn.jsdelivr.net/npm/@mediapipe/hands',
                    modelType: 'lite'  // –õ–µ–≥–∫–∞ –º–æ–¥–µ–ª—å –¥–ª—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ
                };
                handDetector = await handPoseDetection.createDetector(model, detectorConfig);
                console.log("‚úÖ Handpose –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ!");
                loader.style.display = 'none';
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                detectHands();
            } catch (error) {
                console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ Handpose:", error);
            }
        }

        async function detectHands() {
            const video = document.querySelector('a-scene').components.camera.el.components.camera.camera;
            if (!video) {
                console.error("‚ùå –í—ñ–¥–µ–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!");
                return;
            }
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const hands = await handDetector.estimateHands(video, { flipHorizontal: true });
            if (hands.length > 0) {
                handDetected = true;
                const keypoints = hands[0].keypoints3D;
                const palmX = keypoints[0].x * canvas.width;  // –ù–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è
                const palmY = keypoints[0].y * canvas.height;
                const palmZ = keypoints[0].z;
                handPosition = { x: (palmX / canvas.width) - 0.5, y: (palmY / canvas.height) - 0.5, z: palmZ * -0.5 };
                console.log("üñêÔ∏è –†—É–∫–∞ –≤–∏—è–≤–ª–µ–Ω–∞ –Ω–∞ –ø–æ–∑–∏—Ü—ñ—ó:", handPosition);
                updatePlanet(keypoints);
            } else {
                handDetected = false;
                handPlanet.setAttribute('visible', 'false');
            }
            requestAnimationFrame(detectHands);
        }

        function updatePlanet(keypoints) {
            if (!handDetected) return;
            handPlanet.setAttribute('visible', 'true');
            handPlanet.setAttribute('position', `${handPosition.x} ${-handPosition.y} ${handPosition.z - 0.5}`);  // –ö–æ—Ä–µ–∫—Ü—ñ—è –¥–ª—è A-Frame

            const currentTime = Date.now();
            const dx = Math.abs(handPosition.x - lastHandPosition.x);
            const dy = Math.abs(handPosition.y - lastHandPosition.y);
            lastHandPosition = { ...handPosition };

            if (dx > MOVE_THRESHOLD || dy > MOVE_THRESHOLD) {
                lastMoveTime = currentTime;
                handPlanet.emit('fly');
                handPlanet.setAttribute('position', `${handPosition.x + Math.sin(currentTime / 1000) * 0.1} ${-handPosition.y + Math.cos(currentTime / 1000) * 0.1} ${handPosition.z - 0.5}`);
            } else if (currentTime - lastMoveTime > STILL_TIME) {
                handPlanet.removeAttribute('animation__fly');
                handPlanet.setAttribute('position', `${handPosition.x} ${-handPosition.y} ${handPosition.z - 0.5}`);
            }

            // –ó–∞–∫—Ä–∏—Ç—Ç—è –¥–æ–ª–æ–Ω—ñ (—â–∏–ø–æ–∫: –º–∞–ª–∞ –≤—ñ–¥—Å—Ç–∞–Ω—å –º—ñ–∂ –≤–µ–ª–∏–∫–∏–º —ñ –≤–∫–∞–∑—ñ–≤–Ω–∏–º)
            const thumbTip = keypoints[4];  // –ö—ñ–Ω—á–∏–∫ –≤–µ–ª–∏–∫–æ–≥–æ –ø–∞–ª—å—Ü—è
            const indexTip = keypoints[8];  // –ö—ñ–Ω—á–∏–∫ –≤–∫–∞–∑—ñ–≤–Ω–æ–≥–æ
            const pinchDistance = Math.hypot(thumbTip.x - indexTip.x, thumbTip.y - indexTip.y);
            if (pinchDistance < 0.05) {
                handPlanet.setAttribute('visible', 'false');
                console.log("üëÜ –î–æ–ª–æ–Ω—è –∑–∞–∫—Ä–∏—Ç–∞ ‚Äî –ø–ª–∞–Ω–µ—Ç–∞ —Ö–æ–≤–∞—î—Ç—å—Å—è!");
            }
        }
    </script>
</body>
</html>
